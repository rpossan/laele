<% selection = @active_selection || current_user.active_customer_selection %>

<div class="space-y-6">
  <% if selection.nil? %>
    <div class="rounded-lg border border-slate-200 bg-white p-6 text-center">
      <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
      </svg>
      <h3 class="mt-4 text-lg font-semibold text-slate-900"><%= t('campaigns.no_account_selected') %></h3>
      <p class="mt-2 text-sm text-slate-600"><%= t('campaigns.connect_and_select') %></p>
    </div>
  <% else %>
    <!-- Campaign Selection -->
    <div class="rounded-lg border border-slate-200 bg-white p-6">
      <div class="mb-4">
        <h2 class="text-lg font-semibold text-slate-900"><%= t('campaigns.select_campaign') %></h2>
        <p class="mt-1 text-sm text-slate-600"><%= t('campaigns.select_campaign_description') %></p>
      </div>
      
      <div class="mb-4">
        <div class="flex items-center justify-between mb-2">
          <label for="campaign-select" class="block text-sm font-medium text-slate-700">
            <%= t('campaigns.campaign') %>
          </label>
          <a 
            href="https://www.unitedstateszipcodes.org/zip-code-radius-map.php" 
            target="_blank" 
            rel="noopener noreferrer"
            class="inline-flex items-center gap-1 text-xs font-semibold text-indigo-600 hover:text-indigo-700 transition">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
            </svg>
            <%= t('campaigns.view_zip_codes', default: 'Consultar ZIP Codes') %>
          </a>
        </div>
        <select id="campaign-select" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500">
          <option value=""><%= t('campaigns.select_campaign_placeholder') %></option>
        </select>
      </div>

      <button 
        id="fetch-campaigns-btn"
        onclick="fetchCampaigns()"
        class="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-700 transition">
        <svg class="inline-block w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        <%= t('campaigns.fetch_campaigns') %>
      </button>
    </div>

    <!-- Location Management -->
    <div id="location-management" class="hidden rounded-lg border border-slate-200 bg-white p-6">
      <div class="mb-4">
        <h2 class="text-lg font-semibold text-slate-900"><%= t('campaigns.manage_locations') %></h2>
        <p class="mt-1 text-sm text-slate-600"><%= t('campaigns.manage_locations_description') %></p>
      </div>

      <!-- Current Locations Display -->
      <div id="current-locations-section" class="mb-6">
        <h3 class="mb-3 text-sm font-semibold text-slate-700"><%= t('campaigns.current_locations') %></h3>
        <div id="current-locations-list" class="rounded-lg border border-slate-200 bg-slate-50 p-4">
          <p class="text-sm text-slate-500"><%= t('campaigns.loading_locations') %></p>
        </div>
      </div>

      <!-- Geographic Search Component (Two-Stage) -->
      <div class="mb-6">
        <%= render 'dashboard/geographic_search', campaign_id: 'selectedCampaignId' %>
      </div>

      <div class="grid lg:grid-cols-2 gap-6">
        <!-- Unmatched Locations Panel -->
        <div class="rounded-lg border border-amber-200 bg-amber-50 p-4">
          <h3 class="mb-2 text-sm font-semibold text-amber-800">
            <%= t('campaigns.unmatched_locations_title', default: 'Endereços não encontrados') %>
          </h3>
          <p class="mb-2 text-xs text-amber-700">
            <%= t('campaigns.unmatched_locations_hint', default: 'Itens que não foram encontrados na base de GeoTargets aparecerão aqui.') %>
          </p>
          <div id="unmatched-locations-list" class="min-h-[40px] rounded-md border border-dashed border-amber-200 bg-white/70 p-2">
            <p class="text-xs text-amber-500">
              <%= t('campaigns.unmatched_locations_empty', default: 'Nenhum endereço não encontrado até o momento.') %>
            </p>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

<script>
  let selectedCampaignId = null;

  // Função silenciosa para buscar campanhas automaticamente
  async function autoFetchCampaigns() {
    const select = document.getElementById('campaign-select');
    
    if (!select) {
      console.error('Select campaign não encontrado');
      return;
    }

    try {
      
      // Mostrar ícone de carregamento
      const loadingIcon = document.createElement('span');
      loadingIcon.id = 'campaign-loading-icon';
      loadingIcon.innerHTML = '<svg class="inline-block w-4 h-4 mr-2 animate-spin text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>';
      select.parentElement.appendChild(loadingIcon);
      select.disabled = true;
      
      const response = await fetch('/api/google_ads/campaigns', {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
        },
        credentials: 'same-origin'
      });

      if (!response.ok) {
        console.error('Erro ao buscar campanhas:', response.status);
        return;
      }

      const data = await response.json();
      const campaigns = data.campaigns || [];

      if (campaigns.length > 0) {
        // Limpar opções existentes
        select.innerHTML = '<option value=""><%= t('campaigns.select_campaign_placeholder') %></option>';

        // Adicionar campanhas
        campaigns.forEach(campaign => {
          const option = document.createElement('option');
          option.value = campaign.id;
          option.textContent = `${campaign.name} (${campaign.status})`;
          select.appendChild(option);
        });


        // Inicializar Select2 DEPOIS de adicionar as campanhas
        if (typeof jQuery !== 'undefined' && jQuery.fn.select2) {
          
          const selectPlaceholder = window.I18n && window.I18n.campaigns ? window.I18n.campaigns.select_campaign_placeholder : '<%= t('campaigns.select_campaign_placeholder') %>';
          const noResultsText = window.I18n && window.I18n.campaigns ? window.I18n.campaigns.no_campaigns_found : '<%= t('campaigns.no_campaigns_found') %>';
          const searchingText = window.I18n && window.I18n.campaigns ? window.I18n.campaigns.searching : 'Searching...';
          
          jQuery(select).select2({
            placeholder: selectPlaceholder,
            allowClear: true,
            width: '100%',
            language: {
              noResults: function() {
                return noResultsText;
              },
              searching: function() {
                return searchingText;
              }
            }
          });
          
          jQuery(select).on('change', function() {
            selectedCampaignId = this.value;
            const locationManagement = document.getElementById('location-management');
            
            if (this.value) {
              locationManagement.classList.remove('hidden');
              fetchCurrentLocations();
            } else {
              locationManagement.classList.add('hidden');
            }
          });
          
        }
      } else {
        console.log('Nenhuma campanha encontrada');
      }
    } catch (error) {
      console.error('Erro ao buscar campanhas automaticamente:', error);
    } finally {
      // Remover ícone de carregamento
      const loadingIcon = document.getElementById('campaign-loading-icon');
      if (loadingIcon) {
        loadingIcon.remove();
      }
      select.disabled = false;
    }
  }

  async function fetchCampaigns() {
    const btn = document.getElementById('fetch-campaigns-btn');
    const select = document.getElementById('campaign-select');
    
    btn.disabled = true;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<svg class="inline-block w-4 h-4 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg><%= t('campaigns.fetching') %>';

    try {
      const response = await fetch('/api/google_ads/campaigns', {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
        },
        credentials: 'same-origin'
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({ error: `HTTP ${response.status}` }));
        throw new Error(error.error || '<%= t('campaigns.error_fetching') %>');
      }

      const data = await response.json();
      const campaigns = data.campaigns || [];

      // Clear existing options except placeholder
      select.innerHTML = '<option value=""><%= t('campaigns.select_campaign_placeholder') %></option>';

      if (campaigns.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = '<%= t('campaigns.no_campaigns_found') %>';
        option.disabled = true;
        select.appendChild(option);
      } else {
        campaigns.forEach(campaign => {
          const option = document.createElement('option');
          option.value = campaign.id;
          option.textContent = `${campaign.name} (${campaign.status})`;
          select.appendChild(option);
        });
      }

      // Enable select and initialize Select2
      select.disabled = false;
      
      // Initialize Select2 if jQuery is available
      if (typeof jQuery !== 'undefined' && jQuery.fn.select2) {
        const selectPlaceholder = window.I18n && window.I18n.campaigns ? window.I18n.campaigns.select_campaign_placeholder : '<%= t('campaigns.select_campaign_placeholder') %>';
        const noResultsText = window.I18n && window.I18n.campaigns ? window.I18n.campaigns.no_campaigns_found : '<%= t('campaigns.no_campaigns_found') %>';
        const searchingText = window.I18n && window.I18n.campaigns ? window.I18n.campaigns.searching : 'Searching...';
        
        // Destroy existing Select2 instance if any
        if (jQuery(select).hasClass('select2-hidden-accessible')) {
          jQuery(select).select2('destroy');
        }
        
        jQuery(select).select2({
          placeholder: selectPlaceholder,
          allowClear: true,
          width: '100%',
          language: {
            noResults: function() {
              return noResultsText;
            },
            searching: function() {
              return searchingText;
            }
          }
        });
        
      // Add change listener
      jQuery(select).off('change').on('change', function() {
        selectedCampaignId = this.value;
        const applyBtn = document.getElementById('apply-locations-btn');
        const locationManagement = document.getElementById('location-management');
        
        if (this.value) {
          locationManagement.classList.remove('hidden');
          fetchCurrentLocations();
        } else {
          locationManagement.classList.add('hidden');
        }
      });
      } else {
        // Fallback to native select if Select2 is not available
        select.onchange = function() {
          selectedCampaignId = this.value;
          const locationManagement = document.getElementById('location-management');
          
          if (this.value) {
            locationManagement.classList.remove('hidden');
            fetchCurrentLocations();
          } else {
            locationManagement.classList.add('hidden');
          }
        };
      }

      if (window.showSuccess) {
        window.showSuccess(`<%= t('campaigns.campaigns_fetched') %>: ${campaigns.length}`);
      }
    } catch (error) {
      console.error('Error fetching campaigns:', error);
      if (window.showError) {
        window.showError(error.message || '<%= t('campaigns.error_fetching') %>');
      }
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  }

  async function fetchCurrentLocations() {
    if (!selectedCampaignId) return;

    const locationsList = document.getElementById('current-locations-list');
    locationsList.innerHTML = '<p class="text-sm text-slate-500"><%= t('campaigns.loading_locations') %></p>';

    try {
      const response = await fetch(`/api/google_ads/campaign_locations?campaign_id=${selectedCampaignId}`, {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
        },
        credentials: 'same-origin'
      });

      if (!response.ok) {
        throw new Error('<%= t('campaigns.error_fetching_locations') %>');
      }

      const data = await response.json();
      const locations = data.locations || [];

      // Update display tags
      if (locations.length === 0) {
        locationsList.innerHTML = '<p class="text-sm text-slate-500"><%= t('campaigns.no_locations') %></p>';
      } else {
        const locationsHtml = locations.map(loc => {
          const name = loc.name || loc.geo_target_constant || 'Unknown';
          return `<span class="inline-block rounded-full bg-indigo-100 px-3 py-1 text-xs font-medium text-indigo-800 mr-2 mb-2">${name}</span>`;
        }).join('');
        locationsList.innerHTML = locationsHtml;
      }

      // Pre-populate Select2 with existing locations
      if (typeof jQuery !== 'undefined' && jQuery.fn.select2) {
        const locationsSelect = document.getElementById('locations-select');
        if (locationsSelect) {
          // Format locations for Select2
          const select2Data = locations.map(loc => ({
            id: loc.geo_target_constant || loc.resource_name,
            text: `${loc.name || loc.geo_target_constant || 'Unknown'}`
          }));

          const isInitialized = jQuery(locationsSelect).hasClass('select2-hidden-accessible');
          
          if (isInitialized) {
            // If already initialized, update the values
            const currentValues = jQuery(locationsSelect).val() || [];
            const newValues = select2Data.map(item => item.id);
            
            // Add new options that don't exist
            select2Data.forEach(item => {
              if (!jQuery(locationsSelect).find(`option[value="${item.id}"]`).length) {
                const option = new Option(item.text, item.id, false, false);
                jQuery(locationsSelect).append(option);
              }
            });
            
            // Set all existing locations as selected
            jQuery(locationsSelect).val(newValues).trigger('change');
          } else {
            // First time initialization
            // Clear and populate options
            jQuery(locationsSelect).empty();
            select2Data.forEach(item => {
              const option = new Option(item.text, item.id, true, true);
              jQuery(locationsSelect).append(option);
            });
          }
        }
      }
    } catch (error) {
      console.error('Error fetching locations:', error);
      locationsList.innerHTML = '<p class="text-sm text-red-600"><%= t('campaigns.error_fetching_locations') %></p>';
    }
  }



  // Initialize Select2 on page load if campaigns are already loaded
  document.addEventListener('DOMContentLoaded', function() {
    // Nada aqui - autoFetchCampaigns será chamado quando a aba de campanhas for aberta
  });

  // Handle geographic search component event
  document.addEventListener('locationsSelected', function(event) {
    const locations = event.detail.locations;
    
    if (!locations || locations.length === 0) return;

    const locationsSelect = document.getElementById('locations-select');
    if (!locationsSelect) return;

    // Add locations to Select2 if available
    if (typeof jQuery !== 'undefined' && jQuery.fn.select2) {
      const $select = jQuery(locationsSelect);
      const currentValues = $select.val() || [];

      // Add new options for each location
      locations.forEach(location => {
        const optionId = `${location.city}|${location.state}|${location.zip_code}`;
        const optionText = `${location.city}, ${location.state} ${location.zip_code}`;

        // Check if option already exists
        if ($select.find(`option[value="${optionId}"]`).length === 0) {
          const option = new Option(optionText, optionId, false, false);
          $select.append(option);
        }

        // Add to selected values
        if (!currentValues.includes(optionId)) {
          currentValues.push(optionId);
        }
      });

      // Update Select2 with new values
      $select.val(currentValues).trigger('change');

      // Show success message
      if (window.showSuccess) {
        window.showSuccess(`${locations.length} localizações adicionadas com sucesso!`);
      }
    }
  });
</script>
